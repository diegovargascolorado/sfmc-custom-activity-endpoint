<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Enviar a Webhook</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f4f6f9;margin:0;padding:24px}
    .card{max-width:820px;margin:0 auto;background:#fff;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.08);padding:24px}
    h2{margin:0 0 6px;color:#032D60}
    .sub{margin:0 0 18px;color:#6b7280;font-size:13px}
    .info{background:#e8f4fd;border-left:4px solid #0176d3;border-radius:6px;padding:12px 14px;color:#032D60;font-size:13px;margin:14px 0}
    label{display:block;margin:14px 0 6px;font-size:13px;font-weight:700;color:#374151}
    input{width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:14px}
    input:focus{outline:none;border-color:#0176d3;box-shadow:0 0 0 3px rgba(1,118,211,.15)}
    button{margin-top:14px;width:100%;padding:12px;border:0;border-radius:6px;background:#0176d3;color:#fff;font-weight:700;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .ok{display:none;margin-top:10px;color:#2e7d32;font-size:13px;text-align:center}
    .err{display:none;margin-top:10px;color:#b91c1c;font-size:13px;text-align:center}
    .mini{margin-top:10px;font-size:12px;color:#6b7280}
  </style>
</head>
<body>
  <div class="card">
    <h2>üì° Enviar datos a Webhook</h2>
    <p class="sub">Esta actividad enviar√° los datos del contacto cuando pase por el Journey.</p>

    <div class="info">
      Usa <b>webhook.site</b> para probar: copia tu URL √∫nica y p√©gala aqu√≠.
    </div>

    <label for="webhookUrl">URL del Webhook</label>
    <input id="webhookUrl" type="text" placeholder="https://webhook.site/xxxx-xxxx-xxxx-xxxx" />

    <button id="btnSave" onclick="saveConfig()" disabled>Guardar configuraci√≥n</button>

    <div id="ok" class="ok">‚úÖ Configuraci√≥n guardada. Ya puedes darle Done.</div>
    <div id="err" class="err"></div>

    <div class="mini" id="statusMini">Cargando conexi√≥n con Journey Builder‚Ä¶</div>
  </div>

  <!-- SDK estable para Custom Activities -->
  <script src="https://unpkg.com/postmonger@0.0.17/postmonger.js"></script>

  <script>
    // Conexi√≥n con Journey Builder
    var connection = new Postmonger.Session();

    var payload = null; // aqu√≠ Journey manda el estado de la actividad

    var btnSave = document.getElementById("btnSave");
    var ok = document.getElementById("ok");
    var err = document.getElementById("err");
    var statusMini = document.getElementById("statusMini");

    function showError(msg){
      err.style.display = "block";
      err.textContent = msg;
      ok.style.display = "none";
    }
    function showOk(){
      ok.style.display = "block";
      err.style.display = "none";
      setTimeout(()=>{ ok.style.display="none"; }, 2500);
    }

    // 1) Journey inicializa la actividad
    connection.on("initActivity", function(data) {
      payload = data || {};
      var savedUrl = payload?.configurationArguments?.webhookUrl || "";
      document.getElementById("webhookUrl").value = savedUrl;

      btnSave.disabled = false;
      statusMini.textContent = "Conectado a Journey Builder ‚úÖ";
    });

    // 2) Journey pide que validemos (al darle Done/Next)
    connection.on("clickedNext", function() {
      // Guardamos y dejamos avanzar
      saveConfig(true);
    });

    // Muy importante: decirle a Journey qu√© eventos escuchamos
    connection.trigger("ready");

    function saveConfig(isFromNext){
      try{
        if(!payload){
          showError("No hay payload de Journey. Esta p√°gina debe abrirse desde Journey Builder.");
          return;
        }

        var url = document.getElementById("webhookUrl").value.trim();
        if(!url){
          showError("Por favor ingresa la URL de tu webhook.");
          return;
        }

        // Guardar configuraci√≥n en payload
        payload.configurationArguments = payload.configurationArguments || {};
        payload.configurationArguments.webhookUrl = url;

        // Marcar como configurado (CLAVE para que no se quede cargando)
        payload.metaData = payload.metaData || {};
        payload.metaData.isConfigured = true;

        // Enviar actualizaci√≥n a Journey
        connection.trigger("updateActivity", payload);

        showOk();

        // Si el click vino de Done/Next, avanzamos
        if(isFromNext){
          connection.trigger("nextStep");
        }
      }catch(e){
        showError("Error guardando: " + (e.message || e));
      }
    }
  </script>
</body>
</html>
